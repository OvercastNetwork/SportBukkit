From eee1b42a6a14cd78a16284b8598620f14a48b2c2 Mon Sep 17 00:00:00 2001
From: Jedediah Smith <jedediah@silencegreys.com>
Date: Wed, 18 May 2016 03:31:16 -0400
Subject: [PATCH] Enqueue play packets during login


diff --git a/src/main/java/net/minecraft/server/NetworkManager.java b/src/main/java/net/minecraft/server/NetworkManager.java
index 0fb442e..9ffbfbd 100644
--- a/src/main/java/net/minecraft/server/NetworkManager.java
+++ b/src/main/java/net/minecraft/server/NetworkManager.java
@@ -263,6 +263,7 @@ public class NetworkManager extends SimpleChannelInboundHandler<Packet<?>> {
         return this.channel == null;
     }
 
+    public PacketListener getPacketListener() { return i(); } // SportBukkit - method alias
     public PacketListener i() {
         return this.m;
     }
diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java
index 8e18b37..f81efe0 100644
--- a/src/main/java/net/minecraft/server/PlayerConnection.java
+++ b/src/main/java/net/minecraft/server/PlayerConnection.java
@@ -106,10 +106,30 @@ public class PlayerConnection implements PacketListenerPlayIn, ITickable {
 
     boolean clientOnGround; // SportBukkit - only set by client
 
+    // SportBukkit start - queue packets sent before play state
+    private final java.util.Deque<Packet<?>> initialPackets = new java.util.ArrayDeque<Packet<?>>();
+    public void activate() {
+        if(networkManager.getPacketListener() == this) return;
+        networkManager.setPacketListener(this);
+    }
+
+    public void sendInitialPackets() {
+        if(networkManager.getPacketListener() != this) return;
+        while(!initialPackets.isEmpty()) {
+            final Packet<?> packet = initialPackets.remove();
+            try {
+                sendPacket(packet);
+            } catch(RuntimeException e) {
+                LOGGER.error("Exception sending initial " + packet.getClass().getName(), e);
+            }
+        }
+    }
+    // SportBukkit end
+
     public PlayerConnection(MinecraftServer minecraftserver, NetworkManager networkmanager, EntityPlayer entityplayer) {
         this.minecraftServer = minecraftserver;
         this.networkManager = networkmanager;
-        networkmanager.setPacketListener(this);
+        // networkmanager.setPacketListener(this); SportBukkit - do this later
         this.player = entityplayer;
         entityplayer.playerConnection = this;
 
@@ -1142,6 +1162,13 @@ public class PlayerConnection implements PacketListenerPlayIn, ITickable {
     }
 
     public void sendPacket(final Packet<?> packet) {
+        // SportBukkit - queue packets sent before play state
+        if(packet == null) return;
+        if(!equals(networkManager.getPacketListener())) {
+            initialPackets.add(packet);
+            return;
+        }
+        // SportBukkit end
         Packet replacedPacket = packet; // SportBukkit
 
         if (packet instanceof PacketPlayOutChat) {
diff --git a/src/main/java/net/minecraft/server/PlayerList.java b/src/main/java/net/minecraft/server/PlayerList.java
index d3a071a..1e991c9 100644
--- a/src/main/java/net/minecraft/server/PlayerList.java
+++ b/src/main/java/net/minecraft/server/PlayerList.java
@@ -130,7 +130,11 @@ public abstract class PlayerList {
         BlockPosition blockposition = worldserver.getSpawn();
 
         this.a(entityplayer, (EntityPlayer) null, worldserver);
-        PlayerConnection playerconnection = new PlayerConnection(this.server, networkmanager, entityplayer);
+        // SportBukkit start - activate previously created PlayerConnection
+        // PlayerConnection playerconnection = new PlayerConnection(this.server, networkmanager, entityplayer);
+        PlayerConnection playerconnection = entityplayer.playerConnection;
+        playerconnection.activate();
+        // SportBukkit end
 
         playerconnection.sendPacket(new PacketPlayOutLogin(entityplayer.getId(), entityplayer.playerInteractManager.getGameMode(), worlddata.isHardcore(), worldserver.worldProvider.getDimensionManager().getDimensionID(), worldserver.getDifficulty(), this.getMaxPlayers(), worlddata.getType(), worldserver.getGameRules().getBoolean("reducedDebugInfo")));
         entityplayer.getBukkitEntity().sendSupportedChannels(); // CraftBukkit
@@ -223,6 +227,10 @@ public abstract class PlayerList {
         entityplayer.syncInventory();
         // CraftBukkit - Moved from above, added world
         PlayerList.f.info(entityplayer.getName() + "[" + s1 + "] logged in with entity id " + entityplayer.getId() + " at ([" + entityplayer.world.worldData.getName() + "] " + String.format("%.1f", entityplayer.locX) + ", " + String.format("%.1f", entityplayer.locY) + ", " + String.format("%.1f", entityplayer.locZ) + ")");
+
+        // SportBukkit - Send packets that were queued before activation.
+        // Doing this as late as possible maximizes the number of things that will work properly.
+        playerconnection.sendInitialPackets();
     }
 
     public void sendScoreboard(ScoreboardServer scoreboardserver, EntityPlayer entityplayer) {
@@ -477,6 +485,7 @@ public abstract class PlayerList {
         SocketAddress socketaddress = loginlistener.networkManager.getSocketAddress();
 
         EntityPlayer entity = new EntityPlayer(server, server.getWorldServer(0), gameprofile, new PlayerInteractManager(server.getWorldServer(0)));
+        entity.playerConnection = new PlayerConnection(server, loginlistener.networkManager, entity); // SportBukkit - create this right away so it's never null
         entity.hostname = hostname;
         entity.protocolVersion = loginlistener.networkManager.protocolVersion; // Can't reach NetworkManager through CraftPlayer at this point, so copy the value
 
-- 
1.9.0

